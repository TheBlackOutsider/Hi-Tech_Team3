<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .dropdown:hover > #cart-dropdown{
    display: block;
}
    </style>
</head>
<body>
    <label for="q">Quantité: </label>
    <select id="qt" name="q">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
    </select>
    <button type="button" class="add-to-cart" data-id="432" data-name="Pastilles" data-price="29,00" data-weight="97"
        data-url="/produit/pastilles-anti-douleurs/">Ajouter au panier</button>



    <div class="dropdown">
        <div id="cart">
            <p><span id="in-cart-items-num">0</span> Articles</p>
        </div>
    
        <ul id="cart-dropdown" hidden>
            <li id="empty-cart-msg"><a>Votre panier est vide</a></li>
            <li class="go-to-cart hidden"><a href="/panier/">Voir le panier</a></li>
        </ul>


        <table class="table">
            <thead>
                <tr>
                    <th>Article</th>
                    <th>Prix</th>
                    <th>Quantité</th>
                </tr>
            </thead>
            <tbody id="cart-tablebody"></tbody>
        </table>
        
        <p>Sous total : <span class="subtotal"></span>€</p>
        
        <button id="confirm-command">Passer la commande</button>
    </div>

    <script>
        var timeout;
        // au survol apparait
            $('#cart').on({
                mouseenter: function () {
                    $('#cart-dropdown').show();
                },
                mouseleave: function () {
                    timeout = setTimeout(function () {
                        $('#cart-dropdown').hide();
                    }, 200);
                }
            });
            //ne ferme pas dans ma main s'y trouve
            $('#cart-dropdown').on({
                    mouseenter: function () {
                        clearTimeout(timeout);
                    },
                    mouseleave: function () {
                        $('#cart-dropdown').hide();
                    }
                });

 
                function setCookie(cname, cvalue, exdays) {
                        var d = new Date();
                        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
                        var expires = "expires=" + d.toUTCString();

                        // règle le pb des caractères interdits
                        if ('btoa' in window) {
                            cvalue = btoa(cvalue);
                        }

                        document.cookie = cname + "=" + cvalue + "; " + expires + ';path=/';
                    }

                    // La fonction prend trois paramètres: le nom du cookie, 
                    // sa valeur et le nombre de jours avant que celui - ci 
                    // n’expire.Petite explication pour la partie sur les 
                    // caractères interdits.btoa permet d’encoder une chaine 
                    // de caractère en base64, cela évite les problèmes de 
                    // certains navigateurs avec les caractères non Unicode[
                    //     en](notamment Safari et les accents).Si la fonction
                  //      est supportée dans le navigateur, on encode le contenu du cookie en base64.
                    function saveCart(inCartItemsNum, cartArticles) {
                            setCookie('inCartItemsNum', inCartItemsNum, 5);
                            setCookie('cartArticles', JSON.stringify(cartArticles), 5);
                        }

                        // variables pour stocker le nombre d'articles et leurs noms
                            var inCartItemsNum;
                            var cartArticles;

                            // affiche/cache les éléments du panier selon s'il contient des produits
                            function cartEmptyToggle() {
                                if (inCartItemsNum > 0) {
                                    $('#cart-dropdown .hidden').removeClass('hidden');
                                    $('#empty-cart-msg').hide();
                                }

                                else {
                                    $('#cart-dropdown .go-to-cart').addClass('hidden');
                                    $('#empty-cart-msg').show();
                                }
                            }

                            // récupère les informations stockées dans les cookies
                            inCartItemsNum = parseInt(getCookie('inCartItemsNum') ? getCookie('inCartItemsNum') : 0);
                            cartArticles = getCookie('cartArticles') ? JSON.parse(getCookie('cartArticles')) : [];

                            cartEmptyToggle();

                            // affiche le nombre d'article du panier dans le widget
                            $('#in-cart-items-num').html(inCartItemsNum);

                            // hydrate le panier
                            var items = '';
                            cartArticles.forEach(function (v) {
                                items += '<li id="' + v.id + '"><a href="' + v.url + '">' + v.name + '<br><small>Quantité : <span class="qt">' + v.qt + '</span></small></a></li>';
                            });

                            $('#cart-dropdown').prepend(items);


    // click bouton ajout panier
    $('.add-to-cart').click(function () {

        // récupération des infos du produit
        var $this = $(this);
        var id = $this.attr('data-id');
        var name = $this.attr('data-name');
        var price = $this.attr('data-price');
        var weight = $this.attr('data-weight');
        var url = $this.attr('data-url');
        var qt = parseInt($('#qt').val());
        inCartItemsNum += qt;

        // mise à jour du nombre de produit dans le widget
        $('#in-cart-items-num').html(inCartItemsNum);

        var newArticle = true;

        // vérifie si l'article est pas déjà dans le panier
        cartArticles.forEach(function (v) {
            // si l'article est déjà présent, on incrémente la quantité
            if (v.id == id) {
                newArticle = false;
                v.qt += qt;
                $('#' + id).html('<a href="' + url + '">' + name + '<br><small>Quantité : <span class="qt">' + v.qt + '</span></small></a>');
            }
        });

        // s'il est nouveau, on l'ajoute
        if (newArticle) {
            $('#cart-dropdown').prepend('<li id="' + id + '"><a href="' + url + '">' + name + '<br><small>Quantité : <span class="qt">' + qt + '</span></small></a></li>');

            cartArticles.push({
                id: id,
                name: name,
                price: price,
                weight: weight,
                qt: qt,
                url: url
            });
        }

        // sauvegarde le panier
        saveCart(inCartItemsNum, cartArticles);

        // affiche le contenu du panier si c'est le premier article
        cartEmptyToggle();
    });

    
  
    </script>                  
        
</body>
</html>